// Copyright (c) 2005, 2006 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
if("undefined"==typeof Effect)throw"controls.js requires including script.aculo.us' effects.js library";var Autocompleter={};Autocompleter.Base=function(){},Autocompleter.Base.prototype={baseInitialize:function(t,e,i){this.element=$(t),this.update=$(e),this.hasFocus=!1,this.changed=!1,this.active=!1,this.index=0,this.entryCount=0,this.setOptions?this.setOptions(i):this.options=i||{},this.options.paramName=this.options.paramName||this.element.name,this.options.tokens=this.options.tokens||[],this.options.frequency=this.options.frequency||.4,this.options.minChars=this.options.minChars||1,this.options.onShow=this.options.onShow||function(t,e){e.style.position&&"absolute"!=e.style.position||(e.style.position="absolute",Position.clone(t,e,{setHeight:!1,offsetTop:t.offsetHeight})),Effect.Appear(e,{duration:.15})},this.options.onHide=this.options.onHide||function(t,e){new Effect.Fade(e,{duration:.15})},"string"==typeof this.options.tokens&&(this.options.tokens=new Array(this.options.tokens)),this.observer=null,this.element.setAttribute("autocomplete","off"),Element.hide(this.update),Event.observe(this.element,"blur",this.onBlur.bindAsEventListener(this)),Event.observe(this.element,"keypress",this.onKeyPress.bindAsEventListener(this))},show:function(){"none"==Element.getStyle(this.update,"display")&&this.options.onShow(this.element,this.update),!this.iefix&&navigator.appVersion.indexOf("MSIE")>0&&navigator.userAgent.indexOf("Opera")<0&&"absolute"==Element.getStyle(this.update,"position")&&(new Insertion.After(this.update,'<iframe id="'+this.update.id+'_iefix" style="display:none;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);" src="javascript:false;" frameborder="0" scrolling="no"></iframe>'),this.iefix=$(this.update.id+"_iefix")),this.iefix&&setTimeout(this.fixIEOverlapping.bind(this),50)},fixIEOverlapping:function(){Position.clone(this.update,this.iefix,{setTop:!this.update.style.height}),this.iefix.style.zIndex=1,this.update.style.zIndex=2,Element.show(this.iefix)},hide:function(){this.stopIndicator(),"none"!=Element.getStyle(this.update,"display")&&this.options.onHide(this.element,this.update),this.iefix&&Element.hide(this.iefix)},startIndicator:function(){this.options.indicator&&Element.show(this.options.indicator)},stopIndicator:function(){this.options.indicator&&Element.hide(this.options.indicator)},onKeyPress:function(t){if(this.active)switch(t.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:this.selectEntry(),Event.stop(t);case Event.KEY_ESC:return this.hide(),this.active=!1,Event.stop(t),void 0;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:return this.markPrevious(),this.render(),navigator.appVersion.indexOf("AppleWebKit")>0&&Event.stop(t),void 0;case Event.KEY_DOWN:return this.markNext(),this.render(),navigator.appVersion.indexOf("AppleWebKit")>0&&Event.stop(t),void 0}else if(t.keyCode==Event.KEY_TAB||t.keyCode==Event.KEY_RETURN||navigator.appVersion.indexOf("AppleWebKit")>0&&0==t.keyCode)return;this.changed=!0,this.hasFocus=!0,this.observer&&clearTimeout(this.observer),this.observer=setTimeout(this.onObserverEvent.bind(this),1e3*this.options.frequency)},activate:function(){this.changed=!1,this.hasFocus=!0,this.getUpdatedChoices()},onHover:function(t){var e=Event.findElement(t,"LI");this.index!=e.autocompleteIndex&&(this.index=e.autocompleteIndex,this.render()),Event.stop(t)},onClick:function(t){var e=Event.findElement(t,"LI");this.index=e.autocompleteIndex,this.selectEntry(),this.hide()},onBlur:function(){setTimeout(this.hide.bind(this),250),this.hasFocus=!1,this.active=!1},render:function(){if(this.entryCount>0){for(var t=0;t<this.entryCount;t++)this.index==t?Element.addClassName(this.getEntry(t),"selected"):Element.removeClassName(this.getEntry(t),"selected");this.hasFocus&&(this.show(),this.active=!0)}else this.active=!1,this.hide()},markPrevious:function(){this.index>0?this.index--:this.index=this.entryCount-1,this.getEntry(this.index).scrollIntoView(!0)},markNext:function(){this.index<this.entryCount-1?this.index++:this.index=0,this.getEntry(this.index).scrollIntoView(!1)},getEntry:function(t){return this.update.firstChild.childNodes[t]},getCurrentEntry:function(){return this.getEntry(this.index)},selectEntry:function(){this.active=!1,this.updateElement(this.getCurrentEntry())},updateElement:function(t){if(this.options.updateElement)return this.options.updateElement(t),void 0;var e="";if(this.options.select){var i=document.getElementsByClassName(this.options.select,t)||[];i.length>0&&(e=Element.collectTextNodes(i[0],this.options.select))}else e=Element.collectTextNodesIgnoreClass(t,"informal");var s=this.findLastToken();if(-1!=s){var n=this.element.value.substr(0,s+1),o=this.element.value.substr(s+1).match(/^\s+/);o&&(n+=o[0]),this.element.value=n+e}else this.element.value=e;this.element.focus(),this.options.afterUpdateElement&&this.options.afterUpdateElement(this.element,t)},updateChoices:function(t){if(!this.changed&&this.hasFocus){if(this.update.innerHTML=t,Element.cleanWhitespace(this.update),Element.cleanWhitespace(this.update.down()),this.update.firstChild&&this.update.down().childNodes){this.entryCount=this.update.down().childNodes.length;for(var e=0;e<this.entryCount;e++){var i=this.getEntry(e);i.autocompleteIndex=e,this.addObservers(i)}}else this.entryCount=0;this.stopIndicator(),this.index=0,1==this.entryCount&&this.options.autoSelect?(this.selectEntry(),this.hide()):this.render()}},addObservers:function(t){Event.observe(t,"mouseover",this.onHover.bindAsEventListener(this)),Event.observe(t,"click",this.onClick.bindAsEventListener(this))},onObserverEvent:function(){this.changed=!1,this.getToken().length>=this.options.minChars?(this.startIndicator(),this.getUpdatedChoices()):(this.active=!1,this.hide())},getToken:function(){var t=this.findLastToken();if(-1!=t)var e=this.element.value.substr(t+1).replace(/^\s+/,"").replace(/\s+$/,"");else var e=this.element.value;return/\n/.test(e)?"":e},findLastToken:function(){for(var t=-1,e=0;e<this.options.tokens.length;e++){var i=this.element.value.lastIndexOf(this.options.tokens[e]);i>t&&(t=i)}return t}},Ajax.Autocompleter=Class.create(),Object.extend(Object.extend(Ajax.Autocompleter.prototype,Autocompleter.Base.prototype),{initialize:function(t,e,i,s){this.baseInitialize(t,e,s),this.options.asynchronous=!0,this.options.onComplete=this.onComplete.bind(this),this.options.defaultParams=this.options.parameters||null,this.url=i},getUpdatedChoices:function(){entry=encodeURIComponent(this.options.paramName)+"="+encodeURIComponent(this.getToken()),this.options.parameters=this.options.callback?this.options.callback(this.element,entry):entry,this.options.defaultParams&&(this.options.parameters+="&"+this.options.defaultParams),new Ajax.Request(this.url,this.options)},onComplete:function(t){this.updateChoices(t.responseText)}}),Autocompleter.Local=Class.create(),Autocompleter.Local.prototype=Object.extend(new Autocompleter.Base,{initialize:function(t,e,i,s){this.baseInitialize(t,e,s),this.options.array=i},getUpdatedChoices:function(){this.updateChoices(this.options.selector(this))},setOptions:function(t){this.options=Object.extend({choices:10,partialSearch:!0,partialChars:2,ignoreCase:!0,fullSearch:!1,selector:function(t){for(var e=[],i=[],s=t.getToken(),n=0;n<t.options.array.length&&e.length<t.options.choices;n++)for(var o=t.options.array[n],r=t.options.ignoreCase?o.toLowerCase().indexOf(s.toLowerCase()):o.indexOf(s);-1!=r;){if(0==r&&o.length!=s.length){e.push("<li><strong>"+o.substr(0,s.length)+"</strong>"+o.substr(s.length)+"</li>");break}if(s.length>=t.options.partialChars&&t.options.partialSearch&&-1!=r&&(t.options.fullSearch||/\s/.test(o.substr(r-1,1)))){i.push("<li>"+o.substr(0,r)+"<strong>"+o.substr(r,s.length)+"</strong>"+o.substr(r+s.length)+"</li>");break}r=t.options.ignoreCase?o.toLowerCase().indexOf(s.toLowerCase(),r+1):o.indexOf(s,r+1)}return i.length&&(e=e.concat(i.slice(0,t.options.choices-e.length))),"<ul>"+e.join("")+"</ul>"}},t||{})}}),Field.scrollFreeActivate=function(t){setTimeout(function(){Field.activate(t)},1)},Ajax.InPlaceEditor=Class.create(),Ajax.InPlaceEditor.defaultHighlightColor="#FFFF99",Ajax.InPlaceEditor.prototype={initialize:function(t,e,i){this.url=e,this.element=$(t),this.options=Object.extend({paramName:"value",okButton:!0,okText:"ok",cancelLink:!0,cancelText:"cancel",savingText:"Saving...",clickToEditText:"Click to edit",okText:"ok",rows:1,onComplete:function(t,e){new Effect.Highlight(e,{startcolor:this.options.highlightcolor})},onFailure:function(t){alert("Error communicating with the server: "+t.responseText.stripTags())},callback:function(t){return Form.serialize(t)},handleLineBreaks:!0,loadingText:"Loading...",savingClassName:"inplaceeditor-saving",loadingClassName:"inplaceeditor-loading",formClassName:"inplaceeditor-form",highlightcolor:Ajax.InPlaceEditor.defaultHighlightColor,highlightendcolor:"#FFFFFF",externalControl:null,submitOnBlur:!1,ajaxOptions:{},evalScripts:!1},i||{}),!this.options.formId&&this.element.id&&(this.options.formId=this.element.id+"-inplaceeditor",$(this.options.formId)&&(this.options.formId=null)),this.options.externalControl&&(this.options.externalControl=$(this.options.externalControl)),this.originalBackground=Element.getStyle(this.element,"background-color"),this.originalBackground||(this.originalBackground="transparent"),this.element.title=this.options.clickToEditText,this.onclickListener=this.enterEditMode.bindAsEventListener(this),this.mouseoverListener=this.enterHover.bindAsEventListener(this),this.mouseoutListener=this.leaveHover.bindAsEventListener(this),Event.observe(this.element,"click",this.onclickListener),Event.observe(this.element,"mouseover",this.mouseoverListener),Event.observe(this.element,"mouseout",this.mouseoutListener),this.options.externalControl&&(Event.observe(this.options.externalControl,"click",this.onclickListener),Event.observe(this.options.externalControl,"mouseover",this.mouseoverListener),Event.observe(this.options.externalControl,"mouseout",this.mouseoutListener))},enterEditMode:function(t){return this.saving||this.editing?void 0:(this.editing=!0,this.onEnterEditMode(),this.options.externalControl&&Element.hide(this.options.externalControl),Element.hide(this.element),this.createForm(),this.element.parentNode.insertBefore(this.form,this.element),this.options.loadTextURL||Field.scrollFreeActivate(this.editField),t&&Event.stop(t),!1)},createForm:function(){if(this.form=document.createElement("form"),this.form.id=this.options.formId,Element.addClassName(this.form,this.options.formClassName),this.form.onsubmit=this.onSubmit.bind(this),this.createEditField(),this.options.textarea){var t=document.createElement("br");this.form.appendChild(t)}this.options.okButton&&(okButton=document.createElement("input"),okButton.type="submit",okButton.value=this.options.okText,okButton.className="editor_ok_button",this.form.appendChild(okButton)),this.options.cancelLink&&(cancelLink=document.createElement("a"),cancelLink.href="#",cancelLink.appendChild(document.createTextNode(this.options.cancelText)),cancelLink.onclick=this.onclickCancel.bind(this),cancelLink.className="editor_cancel",this.form.appendChild(cancelLink))},hasHTMLLineBreaks:function(t){return this.options.handleLineBreaks?t.match(/<br/i)||t.match(/<p>/i):!1},convertHTMLLineBreaks:function(t){return t.replace(/<br>/gi,"\n").replace(/<br\/>/gi,"\n").replace(/<\/p>/gi,"\n").replace(/<p>/gi,"")},createEditField:function(){var t;t=this.options.loadTextURL?this.options.loadingText:this.getText();if(1!=this.options.rows||this.hasHTMLLineBreaks(t)){this.options.textarea=!0;var e=document.createElement("textarea");e.obj=this,e.name=this.options.paramName,e.value=this.convertHTMLLineBreaks(t),e.rows=this.options.rows,e.cols=this.options.cols||40,e.className="editor_field",this.options.submitOnBlur&&(e.onblur=this.onSubmit.bind(this)),this.editField=e}else{this.options.textarea=!1;var i=document.createElement("input");i.obj=this,i.type="text",i.name=this.options.paramName,i.value=t,i.style.backgroundColor=this.options.highlightcolor,i.className="editor_field";var s=this.options.size||this.options.cols||0;0!=s&&(i.size=s),this.options.submitOnBlur&&(i.onblur=this.onSubmit.bind(this)),this.editField=i}this.options.loadTextURL&&this.loadExternalText(),this.form.appendChild(this.editField)},getText:function(){return this.element.innerHTML},loadExternalText:function(){Element.addClassName(this.form,this.options.loadingClassName),this.editField.disabled=!0,new Ajax.Request(this.options.loadTextURL,Object.extend({asynchronous:!0,onComplete:this.onLoadedExternalText.bind(this)},this.options.ajaxOptions))},onLoadedExternalText:function(t){Element.removeClassName(this.form,this.options.loadingClassName),this.editField.disabled=!1,this.editField.value=t.responseText.stripTags(),Field.scrollFreeActivate(this.editField)},onclickCancel:function(){return this.onComplete(),this.leaveEditMode(),!1},onFailure:function(t){return this.options.onFailure(t),this.oldInnerHTML&&(this.element.innerHTML=this.oldInnerHTML,this.oldInnerHTML=null),!1},onSubmit:function(){var t=this.form,e=this.editField.value;return this.onLoading(),this.options.evalScripts?new Ajax.Request(this.url,Object.extend({parameters:this.options.callback(t,e),onComplete:this.onComplete.bind(this),onFailure:this.onFailure.bind(this),asynchronous:!0,evalScripts:!0},this.options.ajaxOptions)):new Ajax.Updater({success:this.element,failure:null},this.url,Object.extend({parameters:this.options.callback(t,e),onComplete:this.onComplete.bind(this),onFailure:this.onFailure.bind(this)},this.options.ajaxOptions)),arguments.length>1&&Event.stop(arguments[0]),!1},onLoading:function(){this.saving=!0,this.removeForm(),this.leaveHover(),this.showSaving()},showSaving:function(){this.oldInnerHTML=this.element.innerHTML,this.element.innerHTML=this.options.savingText,Element.addClassName(this.element,this.options.savingClassName),this.element.style.backgroundColor=this.originalBackground,Element.show(this.element)},removeForm:function(){this.form&&(this.form.parentNode&&Element.remove(this.form),this.form=null)},enterHover:function(){this.saving||(this.element.style.backgroundColor=this.options.highlightcolor,this.effect&&this.effect.cancel(),Element.addClassName(this.element,this.options.hoverClassName))},leaveHover:function(){this.options.backgroundColor&&(this.element.style.backgroundColor=this.oldBackground),Element.removeClassName(this.element,this.options.hoverClassName),this.saving||(this.effect=new Effect.Highlight(this.element,{startcolor:this.options.highlightcolor,endcolor:this.options.highlightendcolor,restorecolor:this.originalBackground}))},leaveEditMode:function(){Element.removeClassName(this.element,this.options.savingClassName),this.removeForm(),this.leaveHover(),this.element.style.backgroundColor=this.originalBackground,Element.show(this.element),this.options.externalControl&&Element.show(this.options.externalControl),this.editing=!1,this.saving=!1,this.oldInnerHTML=null,this.onLeaveEditMode()},onComplete:function(t){this.leaveEditMode(),this.options.onComplete.bind(this)(t,this.element)},onEnterEditMode:function(){},onLeaveEditMode:function(){},dispose:function(){this.oldInnerHTML&&(this.element.innerHTML=this.oldInnerHTML),this.leaveEditMode(),Event.stopObserving(this.element,"click",this.onclickListener),Event.stopObserving(this.element,"mouseover",this.mouseoverListener),Event.stopObserving(this.element,"mouseout",this.mouseoutListener),this.options.externalControl&&(Event.stopObserving(this.options.externalControl,"click",this.onclickListener),Event.stopObserving(this.options.externalControl,"mouseover",this.mouseoverListener),Event.stopObserving(this.options.externalControl,"mouseout",this.mouseoutListener))}},Ajax.InPlaceCollectionEditor=Class.create(),Object.extend(Ajax.InPlaceCollectionEditor.prototype,Ajax.InPlaceEditor.prototype),Object.extend(Ajax.InPlaceCollectionEditor.prototype,{createEditField:function(){if(!this.cached_selectTag){var t,e=document.createElement("select"),i=this.options.collection||[];i.each(function(i){t=document.createElement("option"),t.value=i instanceof Array?i[0]:i,"undefined"==typeof this.options.value&&(i instanceof Array?this.element.innerHTML==i[1]:i==t.value)&&(t.selected=!0),this.options.value==t.value&&(t.selected=!0),t.appendChild(document.createTextNode(i instanceof Array?i[1]:i)),e.appendChild(t)}.bind(this)),this.cached_selectTag=e}this.editField=this.cached_selectTag,this.options.loadTextURL&&this.loadExternalText(),this.form.appendChild(this.editField),this.options.callback=function(t,e){return"value="+encodeURIComponent(e)}}}),Form.Element.DelayedObserver=Class.create(),Form.Element.DelayedObserver.prototype={initialize:function(t,e,i){this.delay=e||.5,this.element=$(t),this.callback=i,this.timer=null,this.lastValue=$F(this.element),Event.observe(this.element,"keyup",this.delayedListener.bindAsEventListener(this))},delayedListener:function(){this.lastValue!=$F(this.element)&&(this.timer&&clearTimeout(this.timer),this.timer=setTimeout(this.onTimerEvent.bind(this),1e3*this.delay),this.lastValue=$F(this.element))},onTimerEvent:function(){this.timer=null,this.callback(this.element,$F(this.element))}};